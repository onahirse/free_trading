# RSI Scale-In Strategy

## Описание

**RSI Scale-In Strategy** - это торговая стратегия на основе индикатора RSI (Relative Strength Index) с функцией усреднения позиции (докупок). Стратегия разработана для работы с движком бэктестинга и поддерживает торговлю в обе стороны (LONG и SHORT).

## Принцип работы

### Основные концепции

1. **RSI индикатор** - используется для определения перепроданности/перекупленности рынка
2. **Пересечение уровней** - сигналы генерируются при пересечении RSI настраиваемых уровней
3. **Усреднение позиции** - докупки с удвоением объема при каждом следующем уровне
4. **Закрытие по обратному сигналу** - позиция закрывается полностью при появлении противоположного сигнала

### Логика торговли

#### LONG позиции

- **Вход**: RSI пересекает уровень `LONG_ENTRY_LEVEL` (по умолчанию 35) **сверху вниз**
- **Докупки**: RSI пересекает уровни из `LONG_SCALE_LEVELS` (30, 25, 20, 15) **сверху вниз**
- **Закрытие**: RSI пересекает уровень `SHORT_ENTRY_LEVEL` (по умолчанию 65) **снизу вверх**

#### SHORT позиции

- **Вход**: RSI пересекает уровень `SHORT_ENTRY_LEVEL` (по умолчанию 65) **снизу вверх**
- **Докупки**: RSI пересекает уровни из `SHORT_SCALE_LEVELS` (70, 75, 80, 85) **снизу вверх**
- **Закрытие**: RSI пересекает уровень `LONG_ENTRY_LEVEL` (по умолчанию 35) **сверху вниз**

### Система докупок (Scale-In)

Стратегия поддерживает до **4 докупок** с экспоненциальным ростом объема:

| Вход | Мультипликатор | Объем |
|------|----------------|-------|
| Первичный вход | 1x | 100% |
| 1-я докупка | 2x | 200% |
| 2-я докупка | 4x | 400% |
| 3-я докупка | 8x | 800% |
| 4-я докупка | 16x | 1600% |

**Пример**: Если базовый объем = 100 USDT:
- Первый вход: 100 USDT
- 1-я докупка: 200 USDT (общая позиция: 300 USDT)
- 2-я докупка: 400 USDT (общая позиция: 700 USDT)
- 3-я докупка: 800 USDT (общая позиция: 1500 USDT)
- 4-я докупка: 1600 USDT (общая позиция: 3100 USDT)

## Настройки в config.yaml

```yaml
STRATEGY_SETTINGS:
  PATH: "src.logical.strategy.rsi_scale_in.rsi_scale_in_strategy:RSIScaleInStrategy"
  STRATEGY_NAME: "rsi_scale_in"
  MINIMUM_BARS_FOR_STRATEGY_CALCULATION: 100
  
  # ========================================
  # Настройки RSI Scale-In Strategy
  # ========================================
  
  # Период RSI (количество баров для расчета)
  RSI_PERIOD: 6
  
  # LONG позиция настройки
  LONG_ENTRY_LEVEL: 35      # Уровень RSI для первого входа в LONG
  LONG_SCALE_LEVELS:        # Уровни RSI для докупок (до 4 уровней)
    - 30  # 1-я докупка (объем x2)
    - 25  # 2-я докупка (объем x4)
    - 20  # 3-я докупка (объем x8)
    - 15  # 4-я докупка (объем x16)
  
  # SHORT позиция настройки
  SHORT_ENTRY_LEVEL: 65     # Уровень RSI для первого входа в SHORT
  SHORT_SCALE_LEVELS:       # Уровни RSI для докупок (до 4 уровней)
    - 70  # 1-я докупка (объем x2)
    - 75  # 2-я докупка (объем x4)
    - 80  # 3-я докупка (объем x8)
    - 85  # 4-я докупка (объем x16)
  
  # Максимальное количество докупок
  MAX_SCALE_INS: 4
```

## Параметры стратегии

### RSI_PERIOD
- **Тип**: Integer
- **По умолчанию**: 6
- **Описание**: Период для расчета индикатора RSI. Меньшие значения делают RSI более чувствительным к изменениям цены.

### LONG_ENTRY_LEVEL
- **Тип**: Integer (0-100)
- **По умолчанию**: 35
- **Описание**: Уровень RSI для первичного входа в LONG позицию (пересечение сверху вниз).

### LONG_SCALE_LEVELS
- **Тип**: List[Integer]
- **По умолчанию**: [30, 25, 20, 15]
- **Описание**: Уровни RSI для докупок в LONG позиции. Должны быть в **убывающем** порядке.

### SHORT_ENTRY_LEVEL
- **Тип**: Integer (0-100)
- **По умолчанию**: 65
- **Описание**: Уровень RSI для первичного входа в SHORT позицию (пересечение снизу вверх).

### SHORT_SCALE_LEVELS
- **Тип**: List[Integer]
- **По умолчанию**: [70, 75, 80, 85]
- **Описание**: Уровни RSI для докупок в SHORT позиции. Должны быть в **возрастающем** порядке.

### MAX_SCALE_INS
- **Тип**: Integer
- **По умолчанию**: 4
- **Описание**: Максимальное количество докупок (не включая первичный вход).

## Использование

### Запуск бэктеста

1. Обновите `config.yaml`:
```yaml
STRATEGY_SETTINGS:
  PATH: "src.logical.strategy.rsi_scale_in.rsi_scale_in_strategy:RSIScaleInStrategy"
  STRATEGY_NAME: "rsi_scale_in"
```

2. Запустите бэктест:
```bash
python app.py
```

### Программное использование

```python
from src.logical.strategy.rsi_scale_in.rsi_scale_in_strategy import RSIScaleInStrategy
from src.config.config import config

# Получить настройки монеты
coin = config.get_section("COINS")[0]

# Создать стратегию
strategy = RSIScaleInStrategy(coin)

# Запустить стратегию на данных
signal = strategy.run(data, positions, trading_context)
```

## Примеры торговых сценариев

### Сценарий 1: Успешная LONG позиция с 2 докупками

```
Время    | RSI   | Действие              | Объем  | Общая позиция
---------|-------|-----------------------|--------|---------------
10:00    | 40    | -                     | -      | -
11:00    | 34    | LONG вход (35↓)       | 100    | 100
12:00    | 32    | -                     | -      | 100
13:00    | 29    | Докупка 1 (30↓)       | 200    | 300
14:00    | 27    | -                     | -      | 300
15:00    | 24    | Докупка 2 (25↓)       | 400    | 700
16:00    | 30    | -                     | -      | 700
17:00    | 50    | -                     | -      | 700
18:00    | 66    | Закрытие (65↑)        | -700   | 0
```

### Сценарий 2: SHORT позиция с 1 докупкой

```
Время    | RSI   | Действие              | Объем  | Общая позиция
---------|-------|-----------------------|--------|---------------
10:00    | 60    | -                     | -      | -
11:00    | 66    | SHORT вход (65↑)      | 100    | -100
12:00    | 68    | -                     | -      | -100
13:00    | 71    | Докупка 1 (70↑)       | 200    | -300
14:00    | 68    | -                     | -      | -300
15:00    | 50    | -                     | -      | -300
16:00    | 34    | Закрытие (35↓)        | +300   | 0
```

## Архитектура и интеграция

### Совместимость

- ✅ Поддерживает BaseStrategy API
- ✅ Работает с PositionManager
- ✅ Интегрирован с RiskManager
- ✅ Поддерживает систему докупок через SignalHandler
- ✅ Совместим с движком бэктестинга

### Ключевые методы

#### `calculate_rsi(data, period)`
Рассчитывает RSI индикатор с использованием экспоненциального скользящего среднего.

#### `detect_rsi_cross(rsi, level, direction)`
Определяет пересечение RSI уровня в заданном направлении.

#### `get_position_scale_count(positions)`
Возвращает количество докупок в текущей позиции.

#### `should_close_position(positions, rsi)`
Проверяет условия закрытия позиции по обратному сигналу.

#### `run(data, positions, trading_context)`
Основной метод запуска стратегии.

## Преимущества и риски

### Преимущества

✅ **Усреднение позиции**: снижение средней цены входа в просадке  
✅ **Автоматизация**: четкие правила входа/выхода  
✅ **Гибкость**: настраиваемые уровни RSI для разных рынков  
✅ **Двусторонняя торговля**: работа как в LONG, так и в SHORT  

### Риски

⚠️ **Увеличение риска**: каждая докупка удваивает объем  
⚠️ **Просадки**: может накапливать большую позицию в убытке  
⚠️ **Требует капитал**: нужен достаточный депозит для 4 докупок  
⚠️ **Трендовые рынки**: может быть убыточной на сильных трендах  

## Рекомендации по использованию

1. **Размер депозита**: Убедитесь, что у вас достаточно капитала для всех докупок (минимум 31x от базового объема)
2. **Волатильность**: Стратегия лучше работает на боковых рынках с четкими разворотами
3. **Оптимизация**: Протестируйте различные периоды RSI (4, 6, 9, 14) на исторических данных
4. **Уровни**: Подбирайте уровни входа/докупки под конкретный актив
5. **Риск-менеджмент**: Используйте не более 1-2% от депозита на базовый объем

## Дальнейшее развитие

Планируемые улучшения:

- [ ] Добавление фиксированных TP/SL уровней
- [ ] Динамическая регулировка мультипликаторов объема
- [ ] Фильтры трендов (например, MA) для избежания ложных сигналов
- [ ] Частичное закрытие позиций
- [ ] Трейлинг-стоп при достижении прибыли

## Контакты и поддержка

При обнаружении ошибок или предложениях по улучшению создавайте Issue в репозитории проекта.

---

**Версия**: 1.0.0  
**Дата**: 2026-01-17  
**Автор**: free_trading team
